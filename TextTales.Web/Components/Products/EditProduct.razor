@using System.Globalization;
@using TextTales.Models;
@using TextTales.Web.Interfaces;

@attribute [Route(Endpoints.Product.EditUrl)]

@inject IProductService ProductService
@inject ICategoryService CategoryService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<ProductComponent Id="@Id" Model="@Model" Categories="@Categories" SubmitHandler="@SubmitHandler" IsEdit="true">
    <AlertFragmentContent>
        <RadzenAlert Variant="Variant.Filled" AlertStyle="AlertStyle.Danger" Visible="@_isVisible" Text="@_alertText" />
    </AlertFragmentContent>
</ProductComponent>

@code {
    [Parameter]
    public long Id { get; set; }

    private Product Model { get; set; } = new();

    private IEnumerable<Category>? Categories { get; set; }

    private bool _isVisible = false;

    private string _alertText = string.Empty;

    protected async override Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var product = await ProductService.GetProduct(Id);

        if (product is not null)
        {
            Model = product;
            Categories = await CategoryService.GetCategories();
        }
        else
        {
            NavigationManager.NavigateTo(Endpoints.Product.BaseUrl);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Product can't be found!");
        }
    }

    private async Task SubmitHandler()
    {
        var isUpdated = await ProductService.UpdateProduct(Id, Model!);

        if (!isUpdated)
        {
            await DisplayError("Something went wrong! Failed to update product.");

            return;
        }

        NavigationManager.NavigateTo(Endpoints.Product.BaseUrl);
        NotificationService.Notify(NotificationSeverity.Success, "Success", "Product updated successfully!");
    }

    private void OnCancelClickHandler()
    {
        NavigationManager.NavigateTo(Endpoints.Product.BaseUrl);
    }

    private async Task DisplayError(string message)
    {
        _isVisible = true;
        _alertText = message;

        await InvokeAsync(StateHasChanged);

        await Task.Delay(5000);

        _isVisible = false;

        await InvokeAsync(StateHasChanged);
    }
}
